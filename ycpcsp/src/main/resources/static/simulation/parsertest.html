<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script>
    parse("H");
    parse("(H)");
    parse("(H)2");
    parse("(HO)2");
    parse("H2O");
    parse("H2He");
    parse("H2He2");
    parse("H2He2O7");
    parse("H2He2OOOO");
    parse("H2He2O2O3O2");

    function parse(name, indexValue){
        let list = {};
        let startValue = indexValue == null ? 0 : indexValue;

        console.log("parsing " + name);
        let nameLength = name.length;
        for(var i = startValue; i < nameLength;){
            let char = name[i];

            // first letter - uppercase
            if(char.toUpperCase() != char.toLowerCase()){
                // single letter, single value
                if (i+1 >= nameLength){
                    list[char] = list[char] == null ? 1 : list[char] + 1;
                    break;
                }
                let next = name[i+1];
                // second letter - lowercase
                if(next.toUpperCase() != next.toLowerCase() && next.toLowerCase() == next){
                    if(i+2 >= nameLength){
                        list[char+next] = list[char+next] == null ? 1 : list[char+next] + 1;
                        break;
                    }
                    let nextnext = name[i+2];
                    // third letter - lowercase
                    if(nextnext.toUpperCase() != nextnext.toLowerCase() && nextnext.toLowerCase() == nextnext){
                        if(i+3 >= nameLength){
                            list[char+next+nextnext] = list[char+next+nextnext] == null ? 1 : list[char+next+nextnext] + 1;
                            break;
                        }
                        let next3 = name[i+3];
                        if(!isNaN(next3)){
                            list[char+next+nextnext] = list[char+next+nextnext] == null ? parseInt(next3) : list[char+next+nextnext] + parseInt(next3);
                            i+=4;
                        }
                        else{
                            i+=3;
                        }
                    }
                    else if(!isNaN(nextnext)){
                        list[char+next] = list[char+next] == null ? parseInt(nextnext) : list[char+next] + parseInt(nextnext);
                        i+=3
                    }
                    // paren or start of next element
                    else{
                        i+=2;
                    }
                }
                // number
                else if(!isNaN(next)){
                    list[char] = list[char] == null ? parseInt(next) : list[char] + parseInt(next);
                    i+=2;
                }
                // paren or start of next element
                else{
                    list[char] = list[char] == null ? 1 : list[char] + 1;
                    i+=1;
                }
            }
            else if(char == '('){
                let tempList = parse(name, i+1);
                console.log("received from recursive call: ");
                console.log(tempList);
                let tempListKeys = Object.keys(tempList);
                let tempListValues = Object.values(tempList);

                for(var k = 1; k < tempListKeys.length; k++){
                    list[tempListKeys[i]] = list[tempListKeys[i]] == null ? tempListValues[i] : list[tempListKeys[i]] + tempListValues[i];
                }
                i = tempList["nextIndex"];
                console.log("after recursion, i set to: " + i);
            }
            else if(char == ')'){
                console.log("reached end of paren with list: ");
                console.log(list);
                if(i+1 >= nameLength){
                    list["nextIndex"] = i+1;
                    return list;
                }
                let afterClosingParen = name[i+1];
                if(!isNaN(afterClosingParen)){
                    list["nextIndex"] = i+2;
                    let listKeys = Object.keys(list);
                    for(var j = 0; j < listKeys.length; j++){
                        if(listKeys[j] == "nextIndex"){
                            continue;
                        } else{
                            list[listKeys[j]] = list[listKeys[j]] == null ? afterClosingParen : list[listKeys[j]] * afterClosingParen;
                        }
                    }
                    return list;
                }
            }
        }
        console.log("completed list: ");
        console.log(list);
        return list;
    }
</script>
</body>
</html>