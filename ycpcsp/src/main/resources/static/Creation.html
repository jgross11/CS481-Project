<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Creation</title>
</head>
    <style>
        .list{
            height: 10%; 
            overflow: auto;
            display: none;
        }
        .header{
            font-weight: bolder;
            font-size: 25px;
        }
        .subheader{
            font-weight: bold;
            font-size: 20px;
        }
    </style>
    
<body>
    <a href="/" class="button">Home</a><br>
    <div id="creationPageForm">
        <label for="experimentNameBox">Experiment name: </label><br>
        <input type="text" placeholder="Enter the experiment name" id="experimentNameBox"><br>
        
        <label for="experimentCreatorBox">Experiment creator: </label><br>
        <input type="text" placeholder="Experiment Creator" id="experimentCreatorBox" disabled><br><br>

        <div id="experimentComponentListContainer">
            <div id="experimentEquipmentContainer"></div><br>
            <div id="experimentChemicalContainer"></div><br>
            <div id="experimentEquationContainer"></div><br>
            <div id="experimentStepContainer"></div><br>
        </div>

        <label for="ListContainers">Select a component to add: </label><br>
        <div id="ListContainers">
            <div id="equipmentContainer">
                <div class="header" onclick="toggleVisibility(document.getElementById('equipmentListContainer'))">Equipment</div>
                <div class="list" id="equipmentListContainer">
                    
                </div>
            </div>
            
            <div id="chemicalContainer">
                <div class="header" onclick="toggleVisibility(document.getElementById('chemicalSubHeaderContainer'))">Chemical</div>
                <div class="list" id="chemicalSubHeaderContainer">
                    <div class="subheader" id="chemicalSearch" onclick="toggleVisibility(document.getElementById('chemicalSearchContainer'))">Chemical Search</div>
                    <div class="list"id="chemicalSearchContainer">
                        <label for="chemicalSeachBar">Search for chemical</label><br>
                        <input type="text" placeholder="Search for chemical" name="chemicalSeachBar" id="chemicalSeachBar" oninput="searchChemical(this.value)"><br><br>
                        <div id="chemicalSearchResultContainer">
            
                        </div>
                    </div>
                    <div class="subheader" id="chemicalAdd" onclick="toggleVisibility(document.getElementById('insertChemicalFormContainer')); initChemicalCreation()">Add Chemical</div>
                    <div class="list" id="insertChemicalFormContainer">
                        <label for="chemicalNameBox">Enter chemical name</label><br>
                        <div id="chemicalNameBox-error"></div><br>
                        <input type="text" id="chemicalNameBox" placeholder="Ex. Water"><br><br>
            
                        <label for="chemicalFormulaBox">Enter chemical formula</label><br>
                        <div id="chemicalFormulaBox-error"></div><br>
                        <input type="text" id="chemicalFormulaBox" placeholder="Ex. H2O"><br><br>
            
                        <label for="chemicalMassBox">Enter chemical mass (g/mol)</label><br>
                        <div id="chemicalMassBox-error"></div><br>
                        <input type="number" id="chemicalMassBox" placeholder="Ex. 18.01528"><br><br>
            
                        <label for="chemicalDensityBox">Enter chemical density (g/mL)</label><br>
                        <div id="chemicalDensityBox-error"></div><br>
                        <input type="number" id="chemicalDensityBox" placeholder="Ex. 1.0"><br><br>
            
                        Is your chemical water soluble?<br>
                        <div id="solubility-error"></div><br>
                        <input type="radio" id="waterSoluble" name="solubility" value="1">
                        <label for="waterSoluble">Water soluble</label><br>
            
                        <input type="radio" id="notWaterSoluble" name="solubility" value="0">
                        <label for="notWaterSoluble">Not water soluble</label><br><br>
            
                        <label for="chemicalMeltingPoint">Enter melting point temp (deg C)</label><br>
                        <div id="chemicalMeltingPoint-error"></div><br>
                        <input type="text" id="chemicalMeltingPoint" placeholder="Ex. 0.0"><br><br>
            
                        <label for="chemicalBoilingPoint">Enter boiling point temp (deg C)</label><br>
                        <div id="chemicalBoilingPoint-error"></div><br>
                        <input type="number" id="chemicalBoilingPoint" placeholder="Ex. 100.0"><br><br>
            
                        <div id="gasColorPreviewContainer">
                            Gas Color Preview: <br>
                            <div style="width: 50px; height: 50px"id="gasColorPreview"></div>
                        </div>
                        <label for="gasColor">Select the color of your element as a gas:</label><br>
                        <input type="color" id="gasColor" name="gasColor" value="#000000" oninput="updateColor(1)"><br>
                        <label for="gasColorAlpha">Select the alpha channel of your element as a gas:</label><br>
                        <input type="range" min="0" max="255" value="255" class="slider" id="gasColorAlpha" oninput="updateColor(1)"><br><br>
            
            
                        <div id="liquidColorPreviewContainer">
                            Liquid Color Preview: <br>
                            <div style="width: 50px; height: 50px"id="liquidColorPreview"></div>
                        </div>
                        <label for="liquidColor">Select the color of your element as a liquid:</label><br>
                        <input type="color" id="liquidColor" name="liquidColor" value="#000000" oninput="updateColor(2)"><br><br>
                        <label for="liquidColorAlpha">Select the alpha channel of your element as a liquid:</label><br>
                        <input type="range" min="0" max="255" value="255" class="slider" id="liquidColorAlpha" oninput="updateColor(2)"><br><br>
            
            
                        <div id="solidColorPreviewContainer">
                            Solid Color Preview: <br>
                            <div style="width: 50px; height: 50px"id="solidColorPreview"></div>
                        </div>
                        <label for="solidColor">Select the color of your element as a solid:</label><br>
                        <input type="color" id="solidColor" name="solidColor" value="#000000" oninput="updateColor(3)"><br>
                        <label for="solidColorAlpha">Select the alpha channel of your element as a solid:</label><br>
                        <input type="range" min="0" max="255" value="255" class="slider" id="solidColorAlpha" oninput="updateColor(3)"><br><br>
            
                        <div id="chemicalSubmissionError"></div>
                        <input type="button" id="submitButton" value="Submit" onclick="submitChemical()">
                    </div>
                </div>
            </div>
            
            <div id="equationContainer">
                <div class="header" onclick="toggleVisibility(document.getElementById('subheaderContainer'))">Equation</div>
                <div class="list" id="subheaderContainer">
                    <div class="subheader" id="equationSearch" onclick="toggleVisibility(document.getElementById('searchSubheaderContainer'))">Equation Search</div>
                        <div class="list" id="searchSubheaderContainer">
                            <div id="equationList">
                                <label for="equationSeachBar">Search for equation</label><br>
                                <input type="text" placeholder="Search for equation" name="equationSeachBar" id="equationSeachBar" oninput="searchEquation(this.value)"><br><br>
                                <div id="equationSearchResultContainer">
                    
                                </div>
                            </div>
                        </div>
                    <div class="subheader" id="equationAdd" onclick="toggleVisibility(document.getElementById('insertEquationFormContainer')); initEquationCreation()">Add Equation </div>
                    <div class="list" id="insertEquationFormContainer">
                        <div id="equationPreview"></div><br>
                        <div id="equationError"></div><br>
            
                        <input type="button" value="Add Reactant" onclick="addReactant(); updatePreview()"> 
                        <input type="button" value="Add Product" onclick="addProduct(); updatePreview()">
                        <input type="button" value="Submit Equation" onclick="submitEquation()"><br> 
                        <div id="reactantContainer">
                            Reactants <br>
                            <input type="number" name="reactantCoefficient"
                            value="1" min="1" step="1" style="width: 50px"
                            oninput="updatePreview()"> <input name="reactantFormula"type="text" value="H2" style="width: 70px"oninput="updatePreview()" required>
                        </div>
                        <br>
                        <div id="productContainer">
                            Products <br>
                            <input type="number" name="productCoefficient"
                            value="1" min="1" step="1" style="width: 50px"
                            oninput="updatePreview()"> <input name="productFormula"type="text" value="H2" style="width: 70px"oninput="updatePreview()">
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>

    <script src="./helperFunctions.js"></script>
    <script src="./equationFormHandler.js"></script>
    <script src="./chemicalFormHandler.js"></script>
</body>

<script reference="form-tying-together-script.js">

    // contains all usable equipment information
    var allEquipmentList = [
        { Equip: 'BEAKER_50mL', equipmentID:1, name: "Beaker (50mL)"},
        { Equip: 'BEAKER_150mL',equipmentID:2, name: "Beaker (150mL)"},
        { Equip: 'BEAKER_250mL',equipmentID:3, name: "Beaker (250mL)"},
        { Equip: 'BEAKER_600mL',equipmentID:4, name: "Beaker (600mL)"},
        { Equip: 'SCALE',equipmentID:5, name: "Scale"},
        { Equip: 'TRASHCAN',equipmentID:6, name: "Trashcan"},
        { Equip: 'GRADUATED_25mL',equipmentID:7, name: "Graduated Cylinder (25mL)" },
        { Equip: 'GRADUATED_50mL',equipmentID:8, name: "Graduated Cylinder (50mL)" },
        { Equip: 'GRADUATED_100mL',equipmentID:9, name: "Graduated Cylinder (100mL)" },
        { Equip: 'GRADUATED_1000mL',equipmentID:10, name: "Graduated Cylinder (1000mL)" },
        { Equip: 'FLASK_25mL',equipmentID:11, name: "Erlenmeyer Flask (25mL)" },
        { Equip: 'FLASK_50mL',equipmentID:12, name: "Erlenmeyer Flask (50mL)" },
        { Equip: 'FLASK_100mL',equipmentID:13, name: "Erlenmeyer Flask (100mL)" },
        { Equip: 'FLASK_1000mL',equipmentID:14, name: "Erlenmeyer Flask (1000mL)" },
        { Equip: 'WEIGH_BOAT',equipmentID:15, name: "Weigh Boat" },
        { Equip: 'STIR_ROD',equipmentID:16, name: "Stir Rod" }
    ];

    // experiment lists
    let chems = [];
    let equipments = [];
    let chemInfos = [];
    let equations = [];
    let steps = [];

    // contains chemicals that have been displayed, not necessarily used yet
    let chemDisplay = [];

    // experiment list divs
    let chemicalDiv = null;
    let equipmentDiv = null;
    let equationDiv = null;
    let stepDiv = null;
    
    initCreation();

    
    
    // Calls all relevant functions necessary to load all components of the create experiment page
    function initCreation(){
        
        // only allow components to be created if user is logged in and has verified their account
        let user = JSON.parse(sessionStorage.getItem("user"));
        let listDivList = document.getElementsByClassName("list");
        
        if(user != null && !user.isQuarantined){
            console.log("user is not quarantined");
            document.getElementById("experimentCreatorBox").value = user.fullName;
        } else{
            if(user == null){
                console.log("not logged in!");
            } else{
                console.log("quarantine user!");
            }
            // UNCOMMENT WHEN NOT EDITING THIS WEBPAGE
            // writePermissionNotice();
            // return;
        }

        // move the following three functions into above logic when not editing this webpage

        // fetch and display chemicals from DB
        initChemicalSearch();

        // fetch and display equations from DB
        initEquationSearch();

        // display equipments from DB
        loadEquipment();

        // get references for list divs
        chemicalDiv = document.getElementById("experimentChemicalContainer");
        equipmentDiv = document.getElementById("experimentEquipmentContainer");
        stepDiv = document.getElementById("experimentStepContainer");
        equationsDiv = document.getElementById("experimentEquationContainer");
    }

    // updates contents of the "equipment in experiment" list div
    function updateExperimentEquipmentList(){
        equipmentDiv.innerHTML = "Equipment in experiment: <br>";
        console.log(equipments);
        for(let i = 0; i < equipments.length; i++){
            let equip = equipments[i];
            console.log(equip);
            if(equip != null){
                equipmentDiv.innerHTML += "<div id='experimentEquipmentComponent'>"+allEquipmentList[i].name+": "+equip.quantity+"</div>";
            }
        }
    }

    // Creates webpage list of all addable equipment
    function loadEquipment(){
        let equipmentListDiv = document.getElementById("equipmentListContainer");
        for(let i = 0; i < allEquipmentList.length; i++){
            let equipment = allEquipmentList[i];
            equipmentListDiv.innerHTML += "<div id='equipmentPiece' onclick='addEquipment("+i+")'>"+equipment.name+"</div>";
        }
    }

    // given the index within allEquipmentsList of a piece of equipment,
    // either add that piece of equipment to the experiment equipment list
    // or increment the current quantity within the list, and update the display
    function addEquipment(equipmentIndex){
        let equipment = allEquipmentList[equipmentIndex];
        if(equipments[equipmentIndex] != null){
            equipments[equipmentIndex].quantity++;
        } else{
            equipments[equipmentIndex] = {equipmentID: equipment.equipmentID, quantity: 1};
        }
        updateExperimentEquipmentList();
    }

    // given the index within allChemicalsList of a chemical,
    // add it to the experiment chemical list if not already in list
    // and then update list display 
    function addChemical(chemicalIndex){
        // allChemicalsList found in chemicalFormHandler.js
        // contains all chemical information in DB
        let chemicalToAdd = allChemicalsList[chemicalIndex];
        let chemID = chemicalToAdd.chemicalInformationID;

        // ensure chem isn't already in experiment
        for(let i = 0; i < chems.length; i++){
            if(chems[i].chemID === chemID){
                console.log("chem already in list");
                return;
            }
        }
        
        chemInfos.push(chemID);
        let chemName = chemicalToAdd.name;
        let mass = 1;
        let concentration =1;
        chemDisplay.push({name: chemName, formula: chemicalToAdd.formula});
        chems.push({chemName, chemID, mass, concentration});
        updateExperimentChemicalList();
    }

    // updates contents of the "chemicals in experiment" list div
    function updateExperimentChemicalList(){
        chemicalDiv.innerHTML = "Chemicals in experiment: <br>";
        console.log(chemDisplay);
        for(let i = 0; i < chemDisplay.length; i++){
            let chem = chemDisplay[i];
            console.log(chem);
            chemicalDiv.innerHTML += "<div id='experimentChemicalComponent'>"+chem.name+": "+chem.formula+"</div>";
        }
    }

    function addEquation(equationIndex){
        // allEquationList found in equationFormHandler.js
        // contains all equation informatino in DB
        let equationToAdd = allEquationList[equationIndex];
        let equationID = equationToAdd.equationID;

        // ensure ID isn't already in experiment
        for(let i = 0; i < equations.length; i++){
            if(equations[i].equationID === equationID){
                console.log("equation already in list");
                return;
            }
        }
        equations.push(equationToAdd);
    }

    // Overwrites creation page HTML to notify user they must log in / verify 
    // their account before they're able to create an experiment
    function writePermissionNotice(){
        document.getElementById("creationPageForm").innerHTML = "You must be <a href='/'> logged in</a>" +
        " and have verified your account via email in order to create an experiment. <br>If you don't have an account, <a href='/signup'>sign up.</a>";
    }

    // menu toggle animation
    function toggleVisibility(div){
        div.style.display = div.style.display == "inline" ? "none" : "inline";
    }
</script>
</html>