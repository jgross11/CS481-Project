<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Creation</title>
</head>
    <style>
        .list{
            height: 10%; 
            overflow: auto;
            display: none;
        }
        .header{
            font-weight: bolder;
            font-size: 25px;
        }
        .subheader{
            font-weight: bold;
            font-size: 20px;
        }
    </style>
    
<body>
    <a href="/" class="button">Home</a><br>
    <div id="creationPageForm">
        <div id="experimentInformationBox">
            <label for="experimentNameBox">Experiment name: </label><br>
            <input type="text" placeholder="Enter the experiment name" id="experimentNameBox"><br>
            
            <label for="experimentCreatorBox">Experiment creator: </label><br>
            <input type="text" placeholder="Experiment Creator" id="experimentCreatorBox" disabled><br><br>

        </div>
        <div id="experimentComponentListContainer">
            <div id="experimentEquipmentContainer"></div><br>
            <div id="experimentChemicalContainer"></div><br>
            <div id="experimentEquationContainer"></div><br>
            <div id="experimentStepContainer"></div><br>
        </div>

        <label for="ListContainers">Select a component to add: </label><br>
        <div id="ListContainers">
            <div id="equipmentContainer">
                <div class="header" onclick="toggleVisibility(document.getElementById('equipmentListContainer'))">Equipment</div>
                <div class="list" id="equipmentListContainer">
                    
                </div>
            </div>
            
            <div id="chemicalContainer">
                <div class="header" onclick="toggleVisibility(document.getElementById('chemicalSubHeaderContainer'))">Chemical</div>
                <div class="list" id="chemicalSubHeaderContainer">
                    <div class="subheader" id="chemicalSearch" onclick="toggleVisibility(document.getElementById('chemicalSearchContainer'))">Chemical Search</div>
                    <div class="list"id="chemicalSearchContainer">
                        <label for="chemicalSeachBar">Search for chemical</label><br>
                        <input type="text" placeholder="Search for chemical" name="chemicalSeachBar" id="chemicalSeachBar" oninput="searchChemical(this.value)"><br><br>
                        <div id="chemicalSearchResultContainer">
            
                        </div>
                    </div>
                    <div class="subheader" id="chemicalAdd" onclick="toggleVisibility(document.getElementById('insertChemicalFormContainer')); initChemicalCreation()">Add Chemical</div>
                    <div class="list" id="insertChemicalFormContainer">
                        <label for="chemicalNameBox">Enter chemical name</label><br>
                        <div id="chemicalNameBox-error"></div><br>
                        <input type="text" id="chemicalNameBox" placeholder="Ex. Water"><br><br>
            
                        <label for="chemicalFormulaBox">Enter chemical formula</label><br>
                        <div id="chemicalFormulaBox-error"></div><br>
                        <input type="text" id="chemicalFormulaBox" placeholder="Ex. H2O"><br><br>
            
                        <label for="chemicalMassBox">Enter chemical mass (g/mol)</label><br>
                        <div id="chemicalMassBox-error"></div><br>
                        <input type="number" id="chemicalMassBox" placeholder="Ex. 18.01528"><br><br>
            
                        <label for="chemicalDensityBox">Enter chemical density (g/mL)</label><br>
                        <div id="chemicalDensityBox-error"></div><br>
                        <input type="number" id="chemicalDensityBox" placeholder="Ex. 1.0"><br><br>
            
                        Is your chemical water soluble?<br>
                        <div id="solubility-error"></div><br>
                        <input type="radio" id="waterSoluble" name="solubility" value="1">
                        <label for="waterSoluble">Water soluble</label><br>
            
                        <input type="radio" id="notWaterSoluble" name="solubility" value="0">
                        <label for="notWaterSoluble">Not water soluble</label><br><br>
            
                        <label for="chemicalMeltingPoint">Enter melting point temp (deg C)</label><br>
                        <div id="chemicalMeltingPoint-error"></div><br>
                        <input type="text" id="chemicalMeltingPoint" placeholder="Ex. 0.0"><br><br>
            
                        <label for="chemicalBoilingPoint">Enter boiling point temp (deg C)</label><br>
                        <div id="chemicalBoilingPoint-error"></div><br>
                        <input type="number" id="chemicalBoilingPoint" placeholder="Ex. 100.0"><br><br>
            
                        <div id="gasColorPreviewContainer">
                            Gas Color Preview: <br>
                            <div style="width: 50px; height: 50px"id="gasColorPreview"></div>
                        </div>
                        <label for="gasColor">Select the color of your element as a gas:</label><br>
                        <input type="color" id="gasColor" name="gasColor" value="#000000" oninput="updateColor(1)"><br>
                        <label for="gasColorAlpha">Select the alpha channel of your element as a gas:</label><br>
                        <input type="range" min="0" max="255" value="255" class="slider" id="gasColorAlpha" oninput="updateColor(1)"><br><br>
            
            
                        <div id="liquidColorPreviewContainer">
                            Liquid Color Preview: <br>
                            <div style="width: 50px; height: 50px"id="liquidColorPreview"></div>
                        </div>
                        <label for="liquidColor">Select the color of your element as a liquid:</label><br>
                        <input type="color" id="liquidColor" name="liquidColor" value="#000000" oninput="updateColor(2)"><br><br>
                        <label for="liquidColorAlpha">Select the alpha channel of your element as a liquid:</label><br>
                        <input type="range" min="0" max="255" value="255" class="slider" id="liquidColorAlpha" oninput="updateColor(2)"><br><br>
            
            
                        <div id="solidColorPreviewContainer">
                            Solid Color Preview: <br>
                            <div style="width: 50px; height: 50px"id="solidColorPreview"></div>
                        </div>
                        <label for="solidColor">Select the color of your element as a solid:</label><br>
                        <input type="color" id="solidColor" name="solidColor" value="#000000" oninput="updateColor(3)"><br>
                        <label for="solidColorAlpha">Select the alpha channel of your element as a solid:</label><br>
                        <input type="range" min="0" max="255" value="255" class="slider" id="solidColorAlpha" oninput="updateColor(3)"><br><br>
            
                        <div id="chemicalSubmissionError"></div>
                        <input type="button" id="submitButton" value="Submit" onclick="submitChemical()">
                    </div>
                </div>
            </div>
            
            <div id="equationContainer">
                <div class="header" onclick="toggleVisibility(document.getElementById('subheaderContainer'))">Equation</div>
                <div class="list" id="subheaderContainer">
                    <div class="subheader" id="equationSearch" onclick="toggleVisibility(document.getElementById('searchSubheaderContainer'))">Equation Search</div>
                        <div class="list" id="searchSubheaderContainer">
                            <div id="equationList">
                                <label for="equationSeachBar">Search for equation</label><br>
                                <input type="text" placeholder="Search for equation" name="equationSeachBar" id="equationSeachBar" oninput="searchEquation(this.value)"><br><br>
                                <div id="equationSearchResultContainer">
                    
                                </div>
                            </div>
                        </div>
                    <div class="subheader" id="equationAdd" onclick="toggleVisibility(document.getElementById('insertEquationFormContainer')); initEquationCreation()">Add Equation </div>
                    <div class="list" id="insertEquationFormContainer">
                        <div id="equationPreview"></div><br>
                        <div id="equationError"></div><br>
            
                        <input type="button" value="Add Reactant" onclick="addReactant(); updatePreview()"> 
                        <input type="button" value="Add Product" onclick="addProduct(); updatePreview()">
                        <input type="button" value="Submit Equation" onclick="submitEquation()"><br> 
                        <div id="reactantContainer">
                            Reactants <br>
                            <input type="number" name="reactantCoefficient"
                            value="1" min="1" step="1" style="width: 50px"
                            oninput="updatePreview()"> <input name="reactantFormula"type="text" value="H2" style="width: 70px"oninput="updatePreview()" required>
                        </div>
                        <br>
                        <div id="productContainer">
                            Products <br>
                            <input type="number" name="productCoefficient"
                            value="1" min="1" step="1" style="width: 50px"
                            oninput="updatePreview()"> <input name="productFormula"type="text" value="H2" style="width: 70px"oninput="updatePreview()">
                        </div>
                    </div>
                </div>
                
                
            </div>

            <div id="stepContainer">
                <div id="addStepFormContainer"></div>
            </div>
        </div>
    </div>

    <!-- error setting, data verification functionality-->
    <script src="./helperFunctions.js"></script>

    <!-- JSON constants for submitting experiment -->
    <script src="./simulation/DataLoader.js"></script>

    <!-- contains all logic for searching, adding, submitting equations-->
    <script src="./equationFormHandler.js"></script>

    <!-- contains all logic for searching, adding, submitting chemicals-->
    <script src="./chemicalFormHandler.js"></script>

    <!-- all experiments that are created will need these scripts 
        for valid step / valid experiment checking -->
    <script src="./simulation/objectIDs.js"></script>
    <script src="./simulation/Experiment.js"></script>
    <script src="./simulation/Instruction.js"></script>
    <script src="./simulation/ExperimentObjects/ExperimentObject.js"></script>
    <script src="./simulation/ExperimentObjects/Equipment.js"></script>
    <script src="./simulation/ExperimentObjects/Containers/Container.js"></script>
    <script src="./simulation/ExperimentObjects/Disposers/Disposer.js"></script>
    
</body>

<script reference="form-tying-together-script.js">

    // user who's creating experiment
    let user = null;

    // experiment lists
    // TODO dicts?
    let chems = [];
    let equipments = [];
    let chemInfos = {};
    let equations = [];
    let steps = [];

    // experiment list divs
    let chemicalListDiv = null;
    let equipmentListDiv = null;
    let equationDiv = null;
    let stepListDiv = null;
    
    // div containing add step button and form div
    let stepFormContainerDiv = null;

    // step form div
    let stepFormDiv = null;

    // set to true when a user can add a step to an experiment
    // (after a certain amount of components have been added)
    let canAddStep = false;

    // set to true when a user can submit their experiment (at least one step exists), false otherwise
    let canSubmitExperiment = false;

    // step creation form state consts
    let STEP_SHOW_FORM = 0;
    let STEP_PROCESS_ACTOR = 1;
    let STEP_PROCESS_CHEMICAL_CREATION = 2;
    let STEP_PROCESS_RECEIVER = 3;
    let STEP_PROCESS_FUNCTION = 4;
    let STEP_PROCESS_SUMMARY = 5;

    // TODO: may be useful sometime?
    // let currentState = -1;
    // let currentNumberOfSteps = 0;

    // object that represents a step as its being created
    let stepInProgress = {};

    // contains status of equipment scripts
    // false - appropriate script(s) not loaded
    // true - appropriate script(s) loaded
    let equipmentScriptStatus = null;
    
    initCreation();

    
    
    // Calls all relevant functions necessary to load all components of the create experiment page
    function initCreation(){
        
        // only allow components to be created if user is logged in and has verified their account
        user = JSON.parse(sessionStorage.getItem("user"));
        let listDivList = document.getElementsByClassName("list");
        
        if(user != null && !user.isQuarantined){
            console.log("user is not quarantined");
            document.getElementById("experimentCreatorBox").value = user.fullName;
        } else{
            if(user == null){
                console.log("not logged in!");
            } else{
                console.log("quarantine user!");
            }
            // UNCOMMENT WHEN NOT EDITING THIS WEBPAGE
            // writePermissionNotice();
            // return;
        }

        // move the following three functions into above logic when not editing this webpage

        // fetch and display chemicals from DB
        initChemicalSearch();

        // fetch and display equations from DB
        initEquationSearch();

        // display equipments from DB
        loadEquipment();

        // get references for list divs
        chemicalListDiv = document.getElementById("experimentChemicalContainer");
        equipmentListDiv = document.getElementById("experimentEquipmentContainer");
        stepListDiv = document.getElementById("experimentStepContainer");
        equationsListDiv = document.getElementById("experimentEquationContainer");
        stepFormContainerDiv = document.getElementById("stepContainer");
        stepFormDiv = document.getElementById("addStepFormContainer");

        // initialize all equipment script statuses to false - not loaded
        // TODO: blame Zaq (probably) for array indices having to start at 1
        // to map to equipmentIDs - I don't make the rules
        equipmentScriptStatus = Array(allEquipmentList.length+1);
        for(let i = 1; i < equipmentScriptStatus.length; i++){
            equipmentScriptStatus[i] = false;
        }
    }

    /*
    handles displaying of 'new step' form in all its
    parts based on the given stateNumber
    0 - create add step button to init step addition process
    1 - actor selection
    2 - chemical information gathering (concentration, quantity, etc.) if selected actor is a chemical
    3 - receiver information
    4 - function 
    5 - step summary / confirmation
    
    ########## NOTE: this function is the yang to handleFormAction's yin
    ########## when working on one, you will almost certainly have to modify
    ########## or reference the other.
    */
    function changeStepFormState(stateNumber){
        console.log('got state number=' + stateNumber);
        switch(stateNumber){
            case STEP_SHOW_FORM:
                // TODO this could be much more sophisticated
                // TODO for example, it could scan the lists of equipment
                // TODO in the experiment to see if it is possible to create a step
                // TODO with the present equipment. 

                // If there are two experiment components (one equipment and one chemical / two (different types of) equipment),
                // then draw the 'add step' button 
                // TODO need to sum non-null equipments, rather than just looking at lengths
                if((Object.keys(chemInfos).length > 0 && equipments.length > 0) || equipments.length > 1){
                    if(!canAddStep){
                        stepFormContainerDiv.insertAdjacentHTML('afterbegin', '<input type="button" value="Add Step" onclick="changeStepFormState(STEP_PROCESS_ACTOR)">');
                        canAddStep = true;
                    }
                } else{
                    canAddStep = false;
                    // remove button if no longer able to add step (removed equipment / chemicals)
                    if(stepFormContainerDiv.children[0].type == "button"){
                        stepFormContainerDiv.removeChild(stepFormContainerDiv.children[0]);
                    }
                    return;
                }
            break;
            
            case STEP_PROCESS_ACTOR:
                // reset any potential step progress
                stepInProgress = {};
                let actorFormCode = '<br><label for="actor">Choose your actor: </label>'+
                                '<select name="actor" id="actor" onchange="handleFormAction(STEP_PROCESS_ACTOR)">' + 
                                '<option value="equipmentDefault">### EQUIPMENT ###</option>';
                for(let i = 0; i < equipments.length; i++){
                    if(equipments[i] != null){
                        let equipment = equipments[i];
                        actorFormCode += '<option id="EQUIPMENT" value="'+(equipment.equipmentID)+'">'+equipment.name+'</option>';
                    }
                }
                if(Object.keys(chemInfos).length > 0){
                    actorFormCode += '<option value="chemicalDefault">### CHEMICALS ###</option>';
                    for(let key in chemInfos){
                        let chem = chemInfos[key];
                        actorFormCode += '<option id="CHEMICAL" value="'+(key)+'">'+ chem.name + " - " + chem.formula +'</option>';
                    }
                }
                actorFormCode += '</select>';
                stepFormDiv.innerHTML = actorFormCode;
            break;
            
            case STEP_PROCESS_CHEMICAL_CREATION:
                // TODO display appropriate unit depending on lab / chemical temperature
                let chemicalCreationFormCode = '<br><input id="quantity" type="number" min = 0 placeholder="Enter amount">'+
                                                '<input id="concentration" type="number" min = 0 placeholder="Enter concentration">'+
                                                '<input type="button" value="Create chemical instance" onclick="handleFormAction(STEP_PROCESS_CHEMICAL_CREATION)">';
                stepFormDiv.innerHTML = chemicalCreationFormCode;
            break;
            
            case STEP_PROCESS_RECEIVER:
                // TODO make this generate only valid receiver options based on the actor object
                let receiverFormCode = '<br><label for="receiver">Choose your receiver: </label>'+
                        '<select name="receiver" id="receiver" onchange="handleFormAction(STEP_PROCESS_RECEIVER)">' + 
                        '<option value="equipmentDefault">### EQUIPMENT ###</option>';
                for(let i = 0; i < equipments.length; i++){
                    if(equipments[i] != null){
                        let equipment = equipments[i];
                        receiverFormCode += '<option id="EQUIPMENT" value="'+(equipment.equipmentID)+'">'+equipment.name+'</option>';
                    }
                }
                if(Object.keys(chemInfos).length > 0){
                    receiverFormCode += '<option value="chemicalDefault">### CHEMICALS ###</option>';
                    for(let key in chemInfos){
                        let chem = chemInfos[key];
                        receiverFormCode += '<option id="CHEMICAL" value="'+(key)+'">'+ chem.name + " - " + chem.formula +'</option>';
                    }
                }
                receiverFormCode += '</select>';
                stepFormDiv.innerHTML = receiverFormCode;
            break;
            
            case STEP_PROCESS_FUNCTION:
                let functionFormCode = '<br><label for="function">Choose your function: </label>'+
                                        '<select name="function" id="function" onchange="handleFormAction(STEP_PROCESS_FUNCTION)">' + 
                                        '<option value="functionDefault">### FUNCTION ###</option>';
                // TODO only display valid functions for actor
                for(let i = 0; i < equipments.length; i++){
                    if(equipments[i] != null){
                        let equipment = equipments[i];
                        functionFormCode += '<option id="FUNCTION" value="'+(equipment.equipmentID)+'">'+equipment.name+'</option>';
                    }
                }
                functionFormCode += '</select>';
                stepFormDiv.innerHTML = functionFormCode;
            break;
            
            case STEP_PROCESS_SUMMARY:
                // TODO format step nicely for humans
                console.log(stepInProgress);
                let summaryCode = '<br>' + 
                (stepInProgress.actorIsEquipment ? equipments[stepInProgress.actorID-1].name : chemInfos[stepInProgress.chemInstanceToAdd.id].name + ", quantity=" + stepInProgress.chemInstanceToAdd.quantity + ", concentration=" + stepInProgress.chemInstanceToAdd.concentration) +
                " acts on " + 
                (stepInProgress.receiverIsEquipment ? equipments[stepInProgress.receiverID-1].name : chemInfos[stepInProgress.chemInstanceToAdd.id].name + ", quantity=" + stepInProgress.chemInstanceToAdd.quantity + ", concentration=" + stepInProgress.chemInstanceToAdd.concentration) +
                " with function " +
                // TODO reformat with actual function text
                stepInProgress.functionID + 
                '<br> <input type="button" value="Create Step" onclick="handleFormAction(STEP_PROCESS_SUMMARY)">';
                stepFormDiv.innerHTML = summaryCode;
            break;
        }
    }

    /*
        handles transitions when submitting partial step information
        based on given stateNumber
        1 - actor selection has been submitted
        2 - chemical instance information has been submitted
        3 - receiver selection has been submitted
        4 - function selection has been submitted
        5 - step confirmation has been submitted

    ########## NOTE: this function is the yang to changeStepForm's yin
    ########## when working on one, you will almost certainly have to modify
    ########## or reference the other.
    */
    function handleFormAction(stateNumber){
        switch(stateNumber){
            case STEP_PROCESS_ACTOR:
                // selection element 
                let actorSelection = document.getElementById("actor");

                // selected option
                let actorChoice = actorSelection.options[actorSelection.selectedIndex];

                // valid choices will have an integer value
                if(isNaN(parseInt(actorChoice.value))){
                    return;
                }
                // set step actor type accordingly
                stepInProgress.actorIsEquipment = actorChoice.id == "EQUIPMENT" ? true : false;

                // set actor id
                stepInProgress.actorID = actorChoice.value;

                console.log('step after actor selection');
                console.log(stepInProgress);

                // update form to draw appropriate next state
                stepInProgress.actorIsEquipment ? changeStepFormState(STEP_PROCESS_RECEIVER) : changeStepFormState(STEP_PROCESS_CHEMICAL_CREATION);
            break;
            
            case STEP_PROCESS_CHEMICAL_CREATION:
                let quantity = document.getElementById('quantity').value;
                let concentration = document.getElementById('concentration').value;
                if(quantity == "" || concentration == "" || isNaN(quantity) || isNaN(concentration)){
                    return;
                }
                else{
                    // chem was chosen as actor, which from the sim standpoint,
                    // is incorrect, and needs to be changed here
                    if(stepInProgress.receiverID == null){
                        console.log(stepInProgress);
                        stepInProgress.chemInstanceToAdd = {id: stepInProgress.actorID, quantity: quantity, concentration: concentration};
                        stepInProgress.receiverID = chems.length;
                        stepInProgress.receiverIsEquipment = false;
                        delete stepInProgress.actorID;
                        delete stepInProgress.actorIsEquipment;
                        console.log(stepInProgress);
                        console.log(chems);
                        changeStepFormState(STEP_PROCESS_RECEIVER);
                    
                    // otherwise, chem was chosen as receiver, which is fine
                    } else{
                        stepInProgress.chemInstanceToAdd = {id: stepInProgress.receiverID, quantity: quantity, concentration: concentration};
                        stepInProgress.receiverID = chems.length;
                        console.log(stepInProgress);
                        console.log(chems);
                        changeStepFormState(STEP_PROCESS_FUNCTION);
                    }
                }
            break;
            
            case STEP_PROCESS_RECEIVER:
                // selection element 
                let receiverSelection = document.getElementById("receiver");

                // selected option
                let receiverChoice = receiverSelection.options[receiverSelection.selectedIndex];

                // valid choices will have an integer value
                if(isNaN(parseInt(receiverChoice.value))){
                    return;
                }
                
                // must check for chemical case, as sim logic dictates adding to container
                // has container as actor, chem as receiver
                // this will be true when chemical was selected as actor, when in the sim,
                // it is actually the receiver...

                // TODO check for invalid step compositions
                if(stepInProgress.actorID == null){
                    // set step receiver type accordingly
                    stepInProgress.actorIsEquipment = receiverChoice.id == "EQUIPMENT" ? true : false;

                    // set actor id
                    stepInProgress.actorID = receiverChoice.value;

                    // update form to draw appropriate next state
                    stepInProgress.actorIsEquipment ? changeStepFormState(STEP_PROCESS_FUNCTION) : changeStepFormState(STEP_PROCESS_CHEMICAL_CREATION);
                } else{
                    // set step receiver type accordingly
                    stepInProgress.receiverIsEquipment = receiverChoice.id == "EQUIPMENT" ? true : false;

                    // set receiver id
                    stepInProgress.receiverID = receiverChoice.value;

                    // update form to draw appropriate next state
                    stepInProgress.receiverIsEquipment ? changeStepFormState(STEP_PROCESS_FUNCTION) : changeStepFormState(STEP_PROCESS_CHEMICAL_CREATION);
                }
                console.log('step after receiver selection');
                console.log(stepInProgress);
            break;
            
            case STEP_PROCESS_FUNCTION:
                // selection element 
                let functionSelection = document.getElementById("function");

                // selected option
                let functionChoice = functionSelection.options[functionSelection.selectedIndex];

                // valid choices will have an integer value
                if(isNaN(parseInt(functionChoice.value))){
                    return;
                }
                
                // set step function accordingly
                stepInProgress.functionID = functionChoice.value;

                console.log('step after function selection');
                console.log(stepInProgress);

                // update form, draw summary
                changeStepFormState(STEP_PROCESS_SUMMARY);
            break;
            
            case STEP_PROCESS_SUMMARY:
                if(stepInProgress.chemInstanceToAdd != null && stepInProgress.chemInstanceToAdd != undefined){
                    chems.push(stepInProgress.chemInstanceToAdd);
                    delete stepInProgress.chemInstanceToAdd;
                }
                steps.push(stepInProgress);
                stepInProgress = {};
                updateExperimentStepList();
                // draw experiment submit button if not already drawn
                if(!canSubmitExperiment){
                    document.getElementById("experimentInformationBox").insertAdjacentHTML(
                        'beforeend', '<input type="button" value="Submit Experiment" onclick="submitExperiment()">');
                    canSubmitExperiment = true;
                }
                changeStepFormState(STEP_PROCESS_ACTOR);
            break;
        }
    }

    // updates contents of the "equipment in experiment" list div
    function updateExperimentEquipmentList(){
        equipmentListDiv.innerHTML = "Equipment in experiment: <br>";
        for(let i = 0; i < equipments.length; i++){
            let equip = equipments[i];
            if(equip != null){
                equipmentListDiv.innerHTML += "<div id='experimentEquipmentComponent'>"+equip.name+": "+equip.quantity+"</div>";
            }
        }
    }

    function updateExperimentStepList(){
        stepListDiv.innerHTML = "Steps in experiment: <br>";
        // TODO formatting
        for(let i = 0; i < steps.length; i++){
            let step = steps[i];
            stepListDiv.innerHTML += '<div id="experimentStepComponent"> Step ' + (i+1) + ": "+
            (step.actorIsEquipment ? equipments[step.actorID-1].name : chemInfos[chems[step.actorID].id].name + ", quantity=" + chems[step.actorID].quantity + ", concentration=" + chems[step.actorID].concentration) +
            " acts on " + 
            (step.receiverIsEquipment ? equipments[step.receiverID-1].name : chemInfos[chems[step.receiverID].id].name + ", quantity=" + chems[step.receiverID].quantity + ", concentration=" + chems[step.receiverID].concentration) +
            " with function " +
            // TODO reformat with actual function text
            step.functionID + 
            '</div>';
        }
    }

    // Creates webpage list of all addable equipment
    function loadEquipment(){
        let equipmentListDiv = document.getElementById("equipmentListContainer");
        for(let i = 0; i < allEquipmentList.length; i++){
            let equipment = allEquipmentList[i];
            equipmentListDiv.innerHTML += "<div id='equipmentPiece' onclick='addEquipment("+i+")'>"+equipment.name+"</div>";
        }
    }

    // given the index within allEquipmentsList of a piece of equipment,
    // either add that piece of equipment to the experiment equipment list
    // or increment the current quantity within the list, and update the display
    function addEquipment(equipmentIndex){

        let equipment = allEquipmentList[equipmentIndex];
        if(equipments[equipmentIndex] != null){
            equipments[equipmentIndex].quantity++;
        } else{
            equipments[equipmentIndex] = {equipmentID: equipment.equipmentID, name: equipment.name, quantity: 1};
        }
        loadEquipmentScript(equipment.equipmentID);
        updateExperimentEquipmentList();
        changeStepFormState(STEP_SHOW_FORM);
    }

    // dynamically loads the appropriate script for a piece of equipment
    // to be used for testing step / experiment validity
    // equipmentIndex: the index of the equipment in allEquipmentList (in ObjectIDs.js)
    function loadEquipmentScript(equipmentIndex){
        let scriptURL = null;
        switch(equipmentIndex){
            case ID_EQUIP_BEAKER_50mL:
            case ID_EQUIP_BEAKER_150mL:
            case ID_EQUIP_BEAKER_250mL:
            case ID_EQUIP_BEAKER_600mL:
                // if any beaker was already added to the experiment, then no need to reimport the script
                if(equipmentScriptStatus[ID_EQUIP_BEAKER_50mL]){
                    return;
                }
                scriptURL = "./simulation/ExperimentObjects/Containers/Beaker.js";
                equipmentScriptStatus[ID_EQUIP_BEAKER_50mL] = true;
                equipmentScriptStatus[ID_EQUIP_BEAKER_150mL] = true;
                equipmentScriptStatus[ID_EQUIP_BEAKER_250mL] = true;
                equipmentScriptStatus[ID_EQUIP_BEAKER_600mL] = true;
            break;
            case ID_EQUIP_SCALE:
                if(equipmentScriptStatus[ID_EQUIP_SCALE]){
                    return;
                }
                scriptURL = "./simulation/ExperimentObjects/Scale.js";
                equipmentScriptStatus[ID_EQUIP_SCALE] = true;
            break;
            case ID_EQUIP_TRASHCAN:
                if(equipmentScriptStatus[ID_EQUIP_TRASHCAN]){
                    return;
                }
                scriptURL = "./simulation/ExperimentObjects/Disposers/Trashcan.js";
                equipmentScriptStatus[ID_EQUIP_TRASHCAN] = true;
            break;
            case ID_EQUIP_GRADUATED_25mL:
            case ID_EQUIP_GRADUATED_50mL:
            case ID_EQUIP_GRADUATED_100mL:
            case ID_EQUIP_GRADUATED_1000mL:
                // if any graduated cylinder was already added to the experiment, then no need to reimport the script
                if(equipmentScriptStatus[ID_EQUIP_GRADUATED_25mL]){
                    return;
                }
                scriptURL = "./simulation/ExperimentObjects/Containers/GraduatedCylinder.js";
                equipmentScriptStatus[ID_EQUIP_GRADUATED_25mL] = true;
                equipmentScriptStatus[ID_EQUIP_GRADUATED_50mL] = true;
                equipmentScriptStatus[ID_EQUIP_GRADUATED_100mL] = true;
                equipmentScriptStatus[ID_EQUIP_GRADUATED_1000mL] = true;
            break;
            case ID_EQUIP_FLASK_25mL:
            case ID_EQUIP_FLASK_50mL:
            case ID_EQUIP_FLASK_125mL:
            case ID_EQUIP_FLASK_1000mL:
                // if any erlenmeyer was already added to the experiment, then no need to reimport the script
                if(equipmentScriptStatus[ID_EQUIP_FLASK_25mL]){
                    return;
                }
                scriptURL = "./simulation/ExperimentObjects/Containers/ErlenmeyerFlask.js";
                equipmentScriptStatus[ID_EQUIP_FLASK_25mL] = true;
                equipmentScriptStatus[ID_EQUIP_FLASK_50mL] = true;
                equipmentScriptStatus[ID_EQUIP_FLASK_125mL] = true;
                equipmentScriptStatus[ID_EQUIP_FLASK_1000mL] = true;
            break;
            case ID_EQUIP_WEIGH_BOAT:
                if(equipmentScriptStatus[ID_EQUIP_WEIGH_BOAT]){
                    return;
                }
                scriptURL = "./simulation/ExperimentObjects/Containers/WeighBoat.js";
                equipmentScriptStatus[ID_EQUIP_WEIGH_BOAT] = true;
            break;
            case ID_EQUIP_STIR_ROD:
                if(equipmentScriptStatus[ID_EQUIP_STIR_ROD]){
                    return;
                }
                scriptURL = "./simulation/ExperimentObjects/StirRod.js";
                equipmentScriptStatus[ID_EQUIP_STIR_ROD] = true;
            break;
        }
        let equipmentScript = document.createElement("script");
        equipmentScript.setAttribute("async", "false");
        equipmentScript.setAttribute("src", scriptURL);
        document.body.appendChild(equipmentScript);
    }

    // given the index within allChemicalsList of a chemical,
    // add it to the experiment chemical list if not already in list
    // and then update list display 
    function addChemical(chemicalIndex){
        // allChemicalsList found in chemicalFormHandler.js
        // contains all chemical information in DB
        let chemicalToAdd = allChemicalsList[chemicalIndex];
        let chemID = chemicalToAdd.chemicalInformationID;

        // ensure chem isn't already in experiment
        for(let key in chemInfos){
            if(key == chemID){
                console.log("chem already in list");
                return;
            }
        }
        chemInfos[chemID] = {name: chemicalToAdd.name, formula: chemicalToAdd.formula};
        updateExperimentChemicalList();
        changeStepFormState(STEP_SHOW_FORM);
    }

    // updates contents of the "chemicals in experiment" list div
    function updateExperimentChemicalList(){
        chemicalListDiv.innerHTML = "Chemicals in experiment: <br>";
        for(let key in chemInfos){
            let chem = chemInfos[key];
            chemicalListDiv.innerHTML += "<div id='experimentChemicalComponent'>"+chem.name+": "+chem.formula+"</div>";
        }
    }

    function addEquation(equationIndex){
        // allEquationList found in equationFormHandler.js
        // contains all equation information in DB
        let equationToAdd = allEquationList[equationIndex];
        let equationID = equationToAdd.equationID;

        // ensure equation isn't already in experiment
        for(let i = 0; i < equations.length; i++){
            if(equations[i].equationID === equationID){
                console.log("equation already in list");
                return;
            }
        }
        equations.push(equationToAdd);
        
        // ensure reactants / products properties for this equation are in chemical properties list
        // TODO: the following could be O(n) with a map but the implementation is left as an exercise to the reader
        // TODO: the listIndex trick is awful, please fix
        for(let i = 0; i < equationToAdd.reactantFormulas.length; i++){
            let reactant = equationToAdd.reactantFormulas[i];
            let reactantInList = false;
            for(let key in chemInfos){
                let infoInList = chemInfos[key];
                if(infoInList.formula === reactant){
                    reactantInList = true;
                    break;
                }
            }
            // add reactant to list if not already in list
            // if adding chemical, may need to now display step button as well
            if(!reactantInList){
                addChemical(allChemicalsMap[reactant].listIndex);
                changeStepFormState(STEP_SHOW_FORM);
            }
        }

        // same thing for the products
        for(let i = 0; i < equationToAdd.productFormulas.length; i++){
            let product = equationToAdd.productFormulas[i];
            let productInList = false;
            for(let key in chemInfos){
                let infoInList = chemInfos[key];
                if(infoInList.formula === product){
                    productInList = true;
                    break;
                }
            }
            // add product to list if not already in list
            // if adding chemical, may need to now display step button as well
            if(!productInList){
                addChemical(allChemicalsMap[product].listIndex);
                changeStepFormState(STEP_SHOW_FORM);
            }
        }
    }

    // Overwrites creation page HTML to notify user they must log in / verify 
    // their account before they're able to create an experiment
    function writePermissionNotice(){
        document.getElementById("creationPageForm").innerHTML = "You must be <a href='/'> logged in</a>" +
        " and have verified your account via email in order to create an experiment. <br>If you don't have an account, <a href='/signup'>sign up.</a>";
    }

    // menu toggle animation
    function toggleVisibility(div){
        div.style.display = div.style.display == "inline" ? "none" : "inline";
    }

    // compiles all relevant lists into an experiment object to be submitted to back end for submission
    function submitExperiment(){
        let title = document.getElementById("experimentNameBox").value;
        if(title == "" || title == null){
            return;
        }
        let experiment = {};
        let grouping = {};
        experiment.steps = steps;
        experiment.chems = chems;
        experiment.equations = equations;
        experiment[EXP_JSON_TITLE] = title;
        experiment[EXP_JSON_CREATOR] = user.fullName;
        experiment[EXP_JSON_CHEM_PROPERTIES] = chemInfos;
        experiment[EXP_JSON_EQUATIONS] = equations;
        experiment[EXP_JSON_EQUIPMENT] = equipments;
        experiment[EXP_JSON_CHEMICALS] = chems;
        experiment[EXP_JSON_INSTRUCTIONS] = steps;
        grouping = {experiment, user};
        console.log(grouping);
        postData('save-new-creation', grouping).then(function(data){
            console.log(data);
        });
        
        /*
            let chems = [];
    let equipments = [];
    let chemInfos = {};
    let equations = [];
    let steps = [];

        let EXP_JSON_TITLE = "title";
        let EXP_JSON_CREATOR = "creatorName";
        let EXP_JSON_CHEM_PROPERTIES = "chemProperties";
        let EXP_JSON_EQUATIONS = "equations";
        let EXP_JSON_EQUIPMENT = "equipment";
        let EXP_JSON_EQUIP_OBJ_ID = "objectID";
        let EXP_JSON_EQUIP_AMOUNT = "amount";
        let EXP_JSON_CHEMICALS = "chemicals";
        let EXP_JSON_CHEM_ID = "id";
        let EXP_JSON_CHEM_MASS = "mass";
        let EXP_JSON_CHEM_CONCENTRATION = "concentration";
        let EXP_JSON_INSTRUCTIONS = "steps";
        let EXP_JSON_INS_STEP_NUM = "stepNumber";
        let EXP_JSON_INS_ACTOR_INDEX = "actorIndex";
        let EXP_JSON_INS_ACTOR_IS_EQUIP = "actorID";
        let EXP_JSON_INS_RECEIVER_INDEX = "receiverIndex";
        let EXP_JSON_INS_RECEIVER_IS_EQUIP = "receiverID";
        let EXP_JSON_INS_FUNC_ID = "functionID";

        function creatExp(){
            let user = JSON.parse(sessionStorage.getItem("user"));

            let exp = {};
            exp[EXP_JSON_TITLE] = prompt("Enter a Title.", "");
            exp[EXP_JSON_CREATOR] = user.firstName;

            exp[EXP_JSON_EQUIPMENT] = sortArrayByKey(sendequip, EXP_JSON_EQUIP_OBJ_ID, false);
            exp[EXP_JSON_CHEMICALS] = sortArrayByKey(sendchem, [EXP_JSON_CHEM_ID, EXP_JSON_CHEM_MASS, EXP_JSON_CHEM_CONCENTRATION], true);
            exp[EXP_JSON_INSTRUCTIONS] = sortArrayByKey(sendsteps, EXP_JSON_INS_STEP_NUM, false);

            return exp;
        }

    
    
    
    */
    }


</script>
</html>